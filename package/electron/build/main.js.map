{"version":3,"file":"main.js","sources":["app/main.js"],"sourcesContent":["/**\r\n * @author    carlosperate\r\n * @copyright 2015 carlosperate https://github.com/carlosperate\r\n * @license   Licensed under the The MIT License (MIT), a copy can be found in\r\n *            the electron project directory LICENSE file.\r\n *\r\n * @fileOverview Electron entry point continues here. Creates windows and\r\n *               handles system events.\r\n */\r\n\r\nconst electron = require('electron');\r\nconst app = electron.app;\r\nconst shell = electron.shell;\r\nconst BrowserWindow = electron.BrowserWindow;\r\n\r\nconst appMenu = require('./appmenu.js');\r\nconst server = require('./servermgr.js');\r\nconst projectLocator = require('./projectlocator.js');\r\nconst createWindow = require('./helpers/window');\r\n\r\nconst winston = require('winston');\r\nconst packageData = require('fs-jetpack').cwd(app.getAppPath()).read('package.json', 'json');\r\nconst tag = '[ArdublocklyElec] ';\r\n\r\n// Global reference of the window object must be maintain, or the window will\r\n// be closed automatically when the JavaScript object is garbage collected.\r\nvar mainWindow = null;\r\nvar splashWindow = null;\r\n\r\n//Add env parameter for development, by darrin 20190322\r\nvar env = packageData.env.name;\r\nvar argv = process.argv.slice(1).toString();\r\nif (argv.indexOf(\"--env=\") > -1) {\r\n    if (argv.indexOf(\"development\") > -1) {\r\n        env = \"development\";\r\n    }\r\n}\r\n\r\n// Set up the app data directory within the Ardublockly root directory\r\n(function setAppData() {\r\n    var appDataPath = projectLocator.getExecDirJetpack().cwd('appdata');\r\n    app.setPath('appData', appDataPath.path());\r\n    app.setPath('userData', appDataPath.path());\r\n    app.setPath('cache', appDataPath.path('GenCache'));\r\n    app.setPath('userCache', appDataPath.path('AppCache'));\r\n    app.setPath('temp', appDataPath.path('temp'));\r\n})();\r\n\r\n// Ensure this is a single instance application\r\n/*\r\nconst shouldQuit = app.makeSingleInstance(function(cmdLine, workingDirectory) {\r\n  // User tried to run a second instance, focus existing window.\r\n  if (mainWindow) {\r\n    if (mainWindow.isMinimized()) mainWindow.restore();\r\n    mainWindow.focus();\r\n  }\r\n});\r\n*/\r\n\r\n// Electron application entry point\r\napp.on('ready', function () {\r\n    /*if (shouldQuit) {\r\n      app.quit();\r\n      return;\r\n    }*/\r\n    require('@electron/remote/main').initialize();\r\n\r\n    setupLogging();\r\n    createSplashWindow();\r\n    server.startServer();\r\n\r\n    mainWindow = createWindow('main', {\r\n        width: 1200,\r\n        height: 765,\r\n        title: 'Ardublockly',\r\n        transparent: false,\r\n        backgroundColor: '#FFFFFF00',\r\n        frame: true,\r\n        show: false,\r\n        webPreferences: {\r\n            nodeIntegration: true,\r\n            contextIsolation: false,\r\n            enableRemoteModule: true,\r\n            webSecurity: true,\r\n            allowDisplayingInsecureContent: false,\r\n            allowRunningInsecureContent: false,\r\n            java: false,\r\n            webgl: false,\r\n            webaudio: true,\r\n            plugins: false,\r\n            experimentalFeatures: false,\r\n            experimentalCanvasFeatures: false,\r\n            overlayScrollbars: true,\r\n            textAreasAreResizable: false,\r\n            directWrite: true,\r\n        }\r\n    });\r\n\r\n    if (env === 'development') {\r\n        appMenu.setArdublocklyMenu(true);\r\n    } else {\r\n        appMenu.setArdublocklyMenu();\r\n    }\r\n    require(\"@electron/remote/main\").enable(mainWindow.webContents);\r\n\r\n    mainWindow.webContents.on('did-fail-load',\r\n        function (event, errorCode, errorDescription) {\r\n            winston.warn(tag + 'Page failed to load (' + errorCode + '). The ' +\r\n                'server is probably not yet running. Trying again in 200 ms.');\r\n            setTimeout(function () {\r\n                mainWindow.webContents.reload();\r\n            }, 350);\r\n        }\r\n    );\r\n\r\n    mainWindow.webContents.on('did-finish-load', function () {\r\n        if (splashWindow !== null) {\r\n            splashWindow.close();\r\n            splashWindow = null;\r\n        }\r\n        mainWindow.show();\r\n        mainWindow.focus();\r\n    });\r\n\r\n    mainWindow.on('close', function () {\r\n        mainWindow = null;\r\n    });\r\n\r\n    // Set the download directory to the home folder\r\n    mainWindow.webContents.session.setDownloadPath(\r\n        process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME']);\r\n\r\n    mainWindow.loadURL('http://localhost:8007/ardublockly');\r\n});\r\n\r\napp.on('window-all-closed', function () {\r\n    server.stopServer();\r\n    app.quit();\r\n});\r\n\r\nfunction createSplashWindow() {\r\n    if (splashWindow === null) {\r\n        var projectJetPath = projectLocator.getProjectRootJetpack();\r\n        var imagePath = 'file://' + projectJetPath.path(\r\n            'ardublockly', 'img', 'ardublockly_splash.png');\r\n\r\n        splashWindow = new BrowserWindow({\r\n            width: 450,\r\n            height: 300,\r\n            frame: false,\r\n            show: true,\r\n            transparent: false,\r\n            backgroundColor: \"#FFFFFF00\",\r\n            images: true,\r\n            center: true,\r\n            alwaysOnTop: true,\r\n            skipTaskbar: true,\r\n            useContentSize: true,\r\n        });\r\n        splashWindow.loadURL(imagePath);\r\n    }\r\n}\r\n\r\nfunction setupLogging() {\r\n    var projectRootPath = projectLocator.getProjectRootPath();\r\n    winston.add(winston.transports.File, {\r\n        json: false,\r\n        filename: projectRootPath + '/ardublockly.log',\r\n        maxsize: 10485760,\r\n        maxFiles: 2\r\n    });\r\n    winston.info(tag + 'Starting Ardublockly version: ' + packageData.version);\r\n    winston.info(tag + 'Ardublockly root dir: ' + projectRootPath);\r\n\r\n    // Relevant OS could be win32, linux, darwin\r\n    winston.info(tag + 'OS detected: ' + process.platform);\r\n}\r\n"],"names":[],"mappings":"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"}